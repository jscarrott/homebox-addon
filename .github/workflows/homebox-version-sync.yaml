name: Sync Homebox releases

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  sync:
    name: Update Homebox version references
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v4.1.4

      - name: Get latest Homebox release
        id: latest
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data } = await github.request('GET /repos/sysadminsmedia/homebox/releases/latest');
            let tag = data.tag_name || '';
            if (tag.startsWith('v')) {
              tag = tag.slice(1);
            }
            if (!tag) {
              core.setFailed('Could not determine Homebox release tag');
            }
            core.setOutput('version', tag);

      - name: Read current add-on version
        id: current
        run: |
          version=$(grep '^version:' example/config.yaml | sed 's/version: *"\?//; s/"$//')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Stop if already on latest Homebox
        if: steps.latest.outputs.version == steps.current.outputs.version
        run: |
          echo "Homebox ${steps.latest.outputs.version} already packaged." >> $GITHUB_STEP_SUMMARY

      - name: Update add-on metadata to Homebox ${{ steps.latest.outputs.version }}
        if: steps.latest.outputs.version != steps.current.outputs.version
        run: |
          python - <<'PY'
          from pathlib import Path

          version = "${{ steps.latest.outputs.version }}"

          config_path = Path("example/config.yaml")
          config_lines = config_path.read_text().splitlines()
          config_path.write_text("\n".join(
              [f'version: "{version}"' if line.startswith("version:") else line for line in config_lines]
          ) + "\n")

          build_path = Path("example/build.yaml")
          replacements = {
              "aarch64": f"ghcr.io/sysadminsmedia/homebox:{version}-arm",
              "amd64": f"ghcr.io/sysadminsmedia/homebox:{version}",
              "armv7": f"ghcr.io/sysadminsmedia/homebox:{version}-arm",
          }
          updated_build = []
          for line in build_path.read_text().splitlines():
              stripped = line.strip()
              for arch, image in replacements.items():
                  if stripped.startswith(f"{arch}:"):
                      indent = line[: line.index(stripped)]
                      line = f'{indent}{arch}: "{image}"'
                      break
              updated_build.append(line)
          build_path.write_text("\n".join(updated_build) + "\n")

          changelog_path = Path("example/CHANGELOG.md")
          lines = changelog_path.read_text().splitlines()
          header = lines[0]
          rest = "\n".join(lines[1:]).lstrip()
          entries = f"## {version}\n\n- Package Homebox release {version} for the Home Assistant add-on.\n\n"
          changelog_path.write_text(f"{header}\n\n{entries}{rest}\n")
          PY

      - name: Create pull request
        if: steps.latest.outputs.version != steps.current.outputs.version
        uses: peter-evans/create-pull-request@v7
        with:
          branch: automation/homebox-${{ steps.latest.outputs.version }}
          commit-message: "chore: track Homebox ${{ steps.latest.outputs.version }}"
          title: Update Homebox add-on to ${{ steps.latest.outputs.version }}
          body: |
            ## Summary
            - bump the add-on version and base images to Homebox ${{ steps.latest.outputs.version }}
            - open a PR so the builder can publish refreshed add-on images after merge

            ## Testing
            - not run (automation workflow)
